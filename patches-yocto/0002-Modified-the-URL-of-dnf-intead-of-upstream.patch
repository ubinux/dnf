From a55184313b6c3d59383be24d2d6d5e7e40df6140 Mon Sep 17 00:00:00 2001
From: Zheng Ruoqin <zhengrq.fnst@cn.fujitsu.com>
Date: Fri, 11 May 2018 02:38:22 +0000
Subject: [PATCH] Modified the URL of dnf intead of upstream.

Signed-off-by: Zheng Ruoqin <zhengrq.fnst@cn.fujitsu.com>
---
 .../recipes-devtools/dnf/dnf/oe-remote.repo.sample |  6 +++
 meta/recipes-devtools/dnf/dnf_2.7.5.bb             | 52 ++++++++++++++++++----
 2 files changed, 50 insertions(+), 8 deletions(-)
 create mode 100644 meta/recipes-devtools/dnf/dnf/oe-remote.repo.sample

diff --git a/meta/recipes-devtools/dnf/dnf/oe-remote.repo.sample b/meta/recipes-devtools/dnf/dnf/oe-remote.repo.sample
new file mode 100644
index 0000000..05e8cd6
--- /dev/null
+++ b/meta/recipes-devtools/dnf/dnf/oe-remote.repo.sample
@@ -0,0 +1,6 @@
+[base]
+name=myrepo
+baseurl=http://127.0.0.1/oe_repo/
+enabled=1
+gpgcheck=0
+
diff --git a/meta/recipes-devtools/dnf/dnf_2.7.5.bb b/meta/recipes-devtools/dnf/dnf_2.7.5.bb
index b88ddb4..71e697b 100644
--- a/meta/recipes-devtools/dnf/dnf_2.7.5.bb
+++ b/meta/recipes-devtools/dnf/dnf_2.7.5.bb
@@ -4,22 +4,19 @@ LIC_FILES_CHKSUM = "file://COPYING;md5=b234ee4d69f5fce4486a80fdaf4a4263 \
                     file://PACKAGE-LICENSING;md5=bfc29916e11321be06924c4fb096fdcc \
                    "
 
-SRC_URI = "git://github.com/rpm-software-management/dnf.git \
-           file://0001-Corretly-install-tmpfiles.d-configuration.patch \
-           file://0001-Do-not-hardcode-etc-and-systemd-unit-directories.patch \
-           file://0005-Do-not-prepend-installroot-to-logdir.patch \
-           file://0029-Do-not-set-PYTHON_INSTALL_DIR-by-running-python.patch \
-           file://0030-Run-python-scripts-using-env.patch \
+SRC_URI = "git://github.com/ubinux/dnf.git;branch=dnf-yocto2.5 \
            "
 
-SRCREV = "564c44667c7014843fa6f1732621093114ec59b2"
+SRC_URI_append_class-target = "file://oe-remote.repo.sample"
+
+SRCREV = "2cb2fde07423d90aee40ba249a4231e85761496a"
 UPSTREAM_CHECK_GITTAGREGEX = "(?P<pver>\d+(\.\d+)+)"
 
 S = "${WORKDIR}/git"
 
 inherit cmake gettext bash-completion distutils3-base systemd
 
-DEPENDS += "libdnf librepo libcomps python3-iniparse"
+DEPENDS += "libdnf librepo libcomps python3-iniparse libnewt-python"
 
 # manpages generation requires http://www.sphinx-doc.org/
 EXTRA_OECMAKE = " -DWITH_MAN=0 -DPYTHON_INSTALL_DIR=${PYTHON_SITEPACKAGES_DIR} -DPYTHON_DESIRED=3"
@@ -49,6 +46,29 @@ RDEPENDS_${PN}_class-target += " \
   python3-gpg \
   "
 
+RDEPENDS_${PN}_class-nativesdk += " \
+  python3-core \
+  python3-codecs \
+  python3-netclient \
+  python3-email \
+  python3-threading \
+  python3-distutils \
+  python3-logging \
+  python3-fcntl \
+  librepo \
+  python3-shell \
+  libcomps \
+  libdnf \
+  python3-sqlite3 \
+  python3-compression \
+  python3-rpm \
+  python3-iniparse \
+  python3-json \
+  python3-curses \
+  python3-misc \
+  python3-gpg \
+  "
+
 RRECOMMENDS_${PN}_class-target += "gnupg"
 
 # Create a symlink called 'dnf' as 'make install' does not do it, but
@@ -66,6 +86,22 @@ do_install_append_class-native() {
                 RPM_NO_CHROOT_FOR_SCRIPTS=1
 }
 
+do_install_append_class-nativesdk() {
+        create_wrapper ${D}/${bindir}/dnf \
+                RPM_CONFIGDIR=${SDKPATHNATIVE}${libdir_nativesdk}/rpm \
+                RPM_NO_CHROOT_FOR_SCRIPTS=1
+        install -m 0755 ${S}/environment-dnf.sh ${D}/${bindir}/environment-dnf.sh
+        install -m 0755 ${S}/dnf-host ${D}/${bindir}/dnf-host
+        install -d ${D}${datadir}/dnf
+        install -m 0755 ${S}/samples/busybox ${D}${datadir}/dnf/busybox
+        install -m 0755 ${S}/samples/systemd ${D}${datadir}/dnf/systemd
+}
+
+do_install_append_class-target() {
+        install -d ${D}${sysconfdir}/yum.repos.d
+        install -m 0644 ${WORKDIR}/oe-remote.repo.sample ${D}${sysconfdir}/yum.repos.d
+}
+
 SYSTEMD_SERVICE_${PN} = "dnf-makecache.service dnf-makecache.timer \
                          dnf-automatic.service dnf-automatic.timer \
                          dnf-automatic-download.service dnf-automatic-download.timer \
-- 
1.8.3.1

